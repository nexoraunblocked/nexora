<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UV Frontend Only</title>

  <!-- 1) UV client runtime + config -->
  <script src="/uv/uv.bundle.js"></script>
  <script src="/uv/uv.config.js"></script>

  <!-- 2) BareMux for transport switching -->
  <script src="/baremux/index.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; background: #111; color: #eee; }
    #controls { display:flex; max-width:600px; margin:4rem auto; gap:8px; }
    #urlInput { flex:1; padding:8px; font-size:1rem; border:none; border-radius:4px; }
    #goBtn { padding:8px 16px; background:#0078ff; border:none; color:#fff; border-radius:4px; cursor:pointer; }
    #iframe { display:none; width:100%; height:calc(100vh - 56px); border:none; }
    body.loaded #iframe { display:block; }
  </style>
</head>
<body>
  <div id="controls">
    <input id="urlInput" type="text" placeholder="Enter site or search" />
    <button id="goBtn">Go</button>
  </div>
  <iframe id="iframe" sandbox="allow-scripts allow-same-origin"></iframe>

  <script>
    (async () => {
      // register UV’s SW
      if ('serviceWorker' in navigator) {
        await navigator.serviceWorker.register('/uv/sw.js');
      }

      // prepare your transport
      const conn = new BareMux.BareMuxConnection('/baremux/worker.js');
      const wisp = `${location.protocol==='https:'?'wss':'ws'}://${location.host}/wisp/`;
      const bare = `${location.protocol==='https:'?'https':'http'}://${location.host}/bare/`;

      const { prefix, encodeUrl } = __uv$config;
      const input = document.getElementById('urlInput');
      const btn   = document.getElementById('goBtn');
      const frame = document.getElementById('iframe');

      input.addEventListener('keydown', e => {
        if (e.key==='Enter') btn.click();
      });

      btn.addEventListener('click', async () => {
        let u = input.value.trim();

        // if no dot → search; else ensure protocol
        if (!u.includes('.')) {
          u = 'https://duckduckgo.com/?q=' + encodeURIComponent(u);
        } else if (!/^https?:\/\//i.test(u)) {
          u = 'https://' + u;
        }

        // lazy-initialize your default (wisp/epoxy) transport
        if (!await conn.getTransport()) {
          await conn.setTransport('/epoxy/index.mjs', [{ wisp }]);
        }

        // load proxied URL
        frame.src = prefix + encodeUrl(u);
        document.body.classList.add('loaded');
      });
    })();
  </script>
</body>
</html>
