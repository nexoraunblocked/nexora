<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script>
  location.href = "/";
</script>
<title>Nexora Chat</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

<style>
:root{
  --page-bg:#000000;
  --panel:#0f1012;
  --panel-2:#141518;

  /* Pink accents */
  --pink:#ff4da6;
  --pink-deep:#b3006b;
  --pink-shadow: rgba(255, 105, 180, 0.5);

  /* Send button + icon */
  --accent: var(--pink);   /* button background */
  --send-icon:#ffffff;     /* arrow/square glyph color */

  /* Text */
  --text:#e8e8ea;
  --muted:#9aa0a6;

  --radius:12px;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  background:var(--page-bg);
  color:var(--text);
  font:500 16px/1.5 Arial, sans-serif; /* default page font */
  display:flex; flex-direction:column;
}

/* App shell */
.app{
  display:flex; flex-direction:column; height:100%;
}

.header{
  height:56px; display:flex; align-items:center; justify-content:center;
  color:var(--muted); font-weight:700; letter-spacing:.3px;
  border-bottom:1px solid rgba(255,255,255,0.06);
  background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
}

/* Chat area */
.chat{
  flex:1; position:relative; overflow:hidden;
  display:flex; flex-direction:column;
}

.scroll{
  flex:1; overflow:auto; padding:20px; gap:10px; display:flex; flex-direction:column;
}

/* Centered intro */
.intro{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  pointer-events:none;
}
.intro h1{
  margin:0;
  font:800 28px/1.1 inherit; /* default page font */
  letter-spacing:.2px;
  background:linear-gradient(90deg,var(--pink),var(--pink-deep));
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; color:transparent;
}

/* Messages */
.msg{max-width:72%; animation:fade .2s ease}

.msg.user{
  align-self:flex-end; background:var(--pink); color:#fff;
  padding:10px 12px; border-radius:18px; border-bottom-right-radius:6px;
  box-shadow:0 6px 20px var(--pink-shadow);
}

.msg.bot{
  align-self:flex-start; background:none; color:var(--text);
  padding:0; border-radius:0;
}

.bot-chunk{margin:6px 0}
.bot-name{font-size:12px; color:var(--muted); margin-bottom:4px}

/* Code blocks */
.code{
  margin:10px 0; border-radius:10px; overflow:hidden; background:var(--panel);
  border:1px solid rgba(255,255,255,0.08);
}

.code-header{
  display:flex; align-items:center; justify-content:space-between;
  background:var(--panel-2); padding:8px 10px; gap:8px;
}

.code-lang{
  font-size:12px; font-weight:700; color:var(--pink); letter-spacing:.2px;
}

.copy-btn{
  appearance:none; border:0; background:transparent; padding:4px; margin:0;
  cursor:pointer; display:flex; align-items:center; justify-content:center; border-radius:8px;
  transition:background .15s ease, transform .05s ease;
}

.copy-btn:hover{background:rgba(255,255,255,0.06)}
.copy-btn:active{transform:scale(0.96)}
.copy-btn img{
  width:16px; height:16px; display:block;
  filter:invert(66%) sepia(58%) saturate(4200%) hue-rotate(306deg) brightness(102%) contrast(96%); /* pink-ish tint */
}

pre{
  margin:0; padding:12px; background:transparent; overflow:auto;
}

code{
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:13px;
}

/* Footer + input */
.footer{
  padding:12px; border-top:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02);
}

.input-row{
  display:flex; gap:10px; align-items:center;
  background:var(--panel-2); border:1px solid rgba(255,255,255,0.08);
  border-radius:999px; padding:6px 8px;
}

/* PINK focus ring (no blue) */
.input-row:focus-within{
  border-color: color-mix(in srgb, var(--pink) 65%, transparent);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--pink) 20%, transparent);
}

.input{
  flex:1; background:transparent; color:var(--text); border:0; outline:0; height:44px;
  padding:0 10px; font-size:16px;
}

.input::placeholder{color:#f2cfe0; opacity:.9}

/* Send button: pink, and arrow/square are white via --send-icon */
.send{
  width:44px; height:44px; min-width:44px; min-height:44px;
  border-radius:50%; border:0; cursor:pointer; display:flex; align-items:center; justify-content:center;
  background:var(--accent);
  color:var(--send-icon);
  font-size:18px; font-weight:900;
  transition:transform .06s ease, filter .15s ease;
}

.send:hover{filter:brightness(1.08)}
.send:active{transform:scale(0.97)}
.send.typing{animation:pulse 1s infinite}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes fade{from{opacity:0; transform:translateY(4px)}to{opacity:1; transform:translateY(0)}}
.hidden{display:none}

/* typing indicator (spinner + text) — make it inline, no box */
.typing-indicator {
  display:inline-flex;
  align-items:center;
  gap:8px;
  color:var(--muted);
  padding:0;
  border-radius:0;
  background:transparent;
  max-width:72%;
  line-height:1;
}

/* Replace previous roller with the new loader, using theme color (--pink) */
.loader {
  width: 2.6rem;           /* reasonable inline size */
  padding: 0.4rem;
  aspect-ratio: 1;
  border-radius: 50%;
  background: var(--pink);
  --sp:
    conic-gradient(#0000 10%, #000),
    linear-gradient(#000 0 0) content-box;
  -webkit-mask: var(--sp);
          mask: var(--sp);
  -webkit-mask-composite: source-out;
          mask-composite: subtract;
  animation: SP 1s infinite linear;
  display:inline-block;
  vertical-align:middle;
}
@keyframes SP { to { transform: rotate(1turn); } }

/* intro typing cursor: thinner, slightly taller than the text, non-blinking */
.intro h1::after{
  content: '';
  display:inline-block;
  width:2px;            /* thinner */
  height:1.2em;         /* a bit taller than the line of text */
  margin-left:6px;
  background:var(--pink);
  vertical-align:middle;
  border-radius:1px;
  transform: translateY(-0.06em); /* center relative to glyphs */
  /* no blink animation - cursor remains visible while intro is active */
}

/* remove blink keyframes usage for the intro cursor */
@keyframes blink{ 0%,50%{ opacity:1 } 51%,100%{ opacity:0 } }
</style>
</head>

<body>
<div class="app">
  <div class="header">Nexora Chat</div>

  <div class="chat">
    <div class="intro" id="intro"><h1>What can I help you with?</h1></div>
    <div class="scroll" id="scroll"></div>
  </div>

  <div class="footer">
    <div class="input-row">
      <input id="prompt" class="input" placeholder="Message AI..." autocomplete="off" />
      <button id="send" class="send" title="Send">↑</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
(function(){
  if(window.NexoraChat) return; // already initialized

  // Helpers (safe to call multiple times)
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function formatLang(raw){
    if(!raw) return "Code";
    const lower = raw.toLowerCase();
    return lower.charAt(0).toUpperCase() + lower.slice(1);
  }

  function renderReplyWithCode(text){
    const re = /```(\w+)?\n([\s\S]*?)```/g;
    let html = "";
    let last = 0;
    let m;

    while((m = re.exec(text)) !== null){
      const preText = text.slice(last, m.index).trim();
      if(preText) html += `<div class="bot-chunk">${escapeHtml(preText)}</div>`;

      const langRaw = m[1] || "";
      const langLabel = formatLang(langRaw);
      const code = m[2];

      html += `
        <div class="code">
          <div class="code-header">
            <span class="code-lang">${escapeHtml(langLabel)}</span>
            <button class="copy-btn" title="Copy">
              <img src="assets/copy-svgrepo-com.svg" alt="Copy">
            </button>
          </div>
          <pre><code class="language-${escapeHtml(langRaw)}">${escapeHtml(code)}</code></pre>
        </div>
      `;
      last = re.lastIndex;
    }

    const postText = text.slice(last).trim();
    if(postText) html += `<div class="bot-chunk">${escapeHtml(postText)}</div>`;

    return html;
  }

  // DOM utility to get elements relative to a root
  function getEls(root){
    root = root || document;
    return {
      scrollEl: (root.querySelector ? root.querySelector("#scroll") : null) || document.querySelector("#scroll"),
      introEl: (root.querySelector ? root.querySelector("#intro") : null) || document.querySelector("#intro"),
      promptEl: (root.querySelector ? root.querySelector("#prompt") : null) || document.querySelector("#prompt"),
      sendEl: (root.querySelector ? root.querySelector("#send") : null) || document.querySelector("#send")
    };
  }

  function addUserMessage(text){
    const { scrollEl } = getEls();
    if(!scrollEl) return;
    const div = document.createElement("div");
    div.className = "msg user";
    div.textContent = text;
    scrollEl.appendChild(div);
    scrollEl.scrollTop = scrollEl.scrollHeight;
  }

  function addBotMessage(markup){
    const { scrollEl } = getEls();
    if(!scrollEl) return;

    const wrap = document.createElement("div");
    wrap.className = "msg bot";

    const name = document.createElement("div");
    name.className = "bot-name";
    name.textContent = "Gemma 2-9B";

    const body = document.createElement("div");
    body.innerHTML = markup;

    wrap.appendChild(name);
    wrap.appendChild(body);
    scrollEl.appendChild(wrap);
    scrollEl.scrollTop = scrollEl.scrollHeight;

    wrap.querySelectorAll(".copy-btn").forEach(btn=>{
      if(btn.dataset.nexoraCopy) return;
      btn.dataset.nexoraCopy = "1";
      btn.onclick = () => {
        const code = btn.closest(".code").querySelector("pre").innerText;
        navigator.clipboard.writeText(code).catch(()=>{});
        const old = btn.innerHTML;
        btn.textContent = "✅";
        setTimeout(()=>{ btn.innerHTML = old; }, 1500);
      };
    });

    // highlight any newly added code blocks
    requestAnimationFrame(()=>{ if(window.hljs) hljs.highlightAll(); });
  }

  // Intro typing loop: types text, then backspaces, loops until stopped
  const introState = new WeakMap(); // map rootElement->controller

  function startIntroLoop(root){
    const els = getEls(root);
    const introEl = els.introEl;
    if(!introEl) return;
    if(introState.has(introEl)) return; // already running

    const h1 = introEl.querySelector('h1');
    if(!h1) return;

    const text = h1.textContent.trim() || "What can I help you with?";
    h1.textContent = '';
    let pos = 0;
    let deleting = false;
    let speed = 80;
    let timer = null;

    function step(){
      if(!introEl || !h1) return stop();
      if(!deleting){
        pos++;
        h1.textContent = text.slice(0,pos);
        if(pos >= text.length){
          // pause before deleting
          deleting = true;
          clearTimeout(timer);
          timer = setTimeout(step, 900);
          return;
        }
      } else {
        pos--;
        h1.textContent = text.slice(0,pos);
        if(pos <= 0){
          deleting = false;
          clearTimeout(timer);
          timer = setTimeout(step, 500);
          return;
        }
      }
      timer = setTimeout(step, deleting ? speed/2 : speed);
    }

    function stop(){
      if(timer) clearTimeout(timer);
      introState.delete(introEl);
      // restore full text if element still present
      if(h1) h1.textContent = text;
      introEl.classList.remove('nexora-intro-running');
    }

    introState.set(introEl, { stop });
    introEl.classList.add('nexora-intro-running');
    timer = setTimeout(step, 500);
  }

  function stopIntroLoop(root){
    const els = getEls(root);
    const introEl = els.introEl;
    if(!introEl) return;
    const ctl = introState.get(introEl);
    if(ctl && typeof ctl.stop === 'function') ctl.stop();
  }

  // Typing indicator (visible while waiting for bot response)
  function showTypingIndicator(){
    const scrollEl = document.querySelector('#scroll');
    if(!scrollEl) return;
    // don't add if already present
    if(document.getElementById('nexora-typing')) return;
    const wrap = document.createElement('div');
    wrap.className = 'msg bot';
    wrap.id = 'nexora-typing';

    const name = document.createElement('div');
    name.className = 'bot-name';
    name.textContent = 'Gemma 2-9B';

    const body = document.createElement('div');
    // use the new loader spinner + "Typing..." label
    body.innerHTML = `<div class="typing-indicator"><div class="loader" aria-hidden="true"></div><div>Typing...</div></div>`;

    wrap.appendChild(name);
    wrap.appendChild(body);
    scrollEl.appendChild(wrap);
    scrollEl.scrollTop = scrollEl.scrollHeight;
  }

  function hideTypingIndicator(){
    const el = document.getElementById('nexora-typing');
    if(el && el.parentNode) el.parentNode.removeChild(el);
  }

  async function sendMessage(){
    const { introEl, promptEl, sendEl, scrollEl } = getEls();
    if(!promptEl || !sendEl) return;

    // Prevent duplicate sends if button is already disabled (in-flight)
    if(sendEl.disabled) return;

    const prompt = promptEl.value.trim();
    if(!prompt) return;

    // stop intro immediately once the user sends
    stopIntroLoop(document);

    if(introEl && !introEl.classList.contains("hidden")){
      introEl.classList.add("hidden");
    }

    addUserMessage(prompt);
    promptEl.value = "";

    // button typing state
    sendEl.disabled = true;
    sendEl.classList.add("typing");
    const oldLabel = sendEl.textContent;
    sendEl.textContent = "◻";

    // show chat typing indicator
    showTypingIndicator();

    try{
      const res = await fetch("https://nexora-learning-logs55.fly.dev/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          model:"openai/gpt-3.5-turbo",
          messages:[{ role:"user", content: prompt }]
        })
      });

      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || "No response";
      const markup = renderReplyWithCode(reply);

      // hide typing indicator, then append the bot reply
      hideTypingIndicator();
      addBotMessage(markup);

    }catch(err){
      hideTypingIndicator();
      addBotMessage(`<div class="bot-chunk">Error: ${escapeHtml(err?.message || String(err))}</div>`);
    }finally{
      sendEl.classList.remove("typing");
      sendEl.textContent = oldLabel;
      sendEl.disabled = false;
      if(scrollEl) scrollEl.scrollTop = scrollEl.scrollHeight;
    }
  }

  // Attach listeners to elements inside a root. Marks send button to avoid double-binding.
  function attachTo(root){
    const { promptEl, sendEl } = getEls(root);
    if(!promptEl || !sendEl) return false;
    if(sendEl.dataset.nexoraAttached) return true;

    // click always sends
    sendEl.addEventListener("click", sendMessage);

    // Track IME/composition so Enter from IME doesn't trigger a send
    promptEl.addEventListener("compositionstart", ()=> { promptEl.dataset.nexoraComposing = "1"; });
    promptEl.addEventListener("compositionend", ()=> { delete promptEl.dataset.nexoraComposing; });

    // Removed: stop intro on focus/input/keydown so intro keeps animating until user sends
    // promptEl.addEventListener("focus", ()=> stopIntroLoop(root));
    // promptEl.addEventListener("input", ()=> stopIntroLoop(root));
    // promptEl.addEventListener("keydown", ()=> stopIntroLoop(root));

    // Primary handler: keydown (robust checks for key/code/keyCode). Prevent default to avoid form submit.
    promptEl.addEventListener("keydown", function(e){
      if(promptEl.dataset.nexoraComposing) return; // ignore while composing (IME)
      const isEnter = e.key === "Enter" || e.code === "Enter" || e.keyCode === 13;
      if(!isEnter) return;
      // allow Shift+Enter to be a newline (if you later change to textarea), send only on Enter alone
      if(e.shiftKey) return;
      e.preventDefault();
      sendMessage();
    });

    // Fallback for environments where keypress is still relevant
    promptEl.addEventListener("keypress", function(e){
      if(promptEl.dataset.nexoraComposing) return;
      const isEnter = e.key === "Enter" || e.keyCode === 13;
      if(!isEnter) return;
      e.preventDefault();
      sendMessage();
    });

    sendEl.dataset.nexoraAttached = "1";

    // Start the intro typing loop for this root (if present)
    startIntroLoop(root);

    return true;
  }

  // Public API
  window.NexoraChat = {
    init(root){
      try{
        attachTo(root && root instanceof Element ? root : document);
      }catch(e){}
    }
  };

  // Auto-initialize immediately and on DOMContentLoaded (covers direct file open)
  window.NexoraChat.init(document);
  if(document.readyState !== "complete"){
    document.addEventListener("DOMContentLoaded", ()=>window.NexoraChat.init(document));
  }

  // Watch for SPA DOM insertions that include the chat elements and auto-init them
  const mo = new MutationObserver(mutations=>{
    for(const m of mutations){
      for(const n of m.addedNodes){
        if(!(n instanceof HTMLElement)) continue;
        if(n.querySelector && (n.querySelector("#send") || n.querySelector("#prompt") || n.querySelector(".app"))){
          window.NexoraChat.init(n);
        } else if(n.id === "send" || n.id === "prompt" || n.classList?.contains("app")){
          window.NexoraChat.init(document);
        }
      }
    }
  });

  // start observing body; if body not ready, try again shortly
  const startObserve = ()=>{
    if(document.body) mo.observe(document.body, { childList:true, subtree:true });
    else setTimeout(startObserve, 50);
  };
  startObserve();

})();
</script>
</body>
</html>
